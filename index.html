<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gothic OS Device</title>
    <link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=UnifrakturMaguntia&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link id="custom-font-link" rel="stylesheet" href="">
    
    <style id="system-style">
        :root {
            --bg-color: #050505;
            --screen-bg: #0a0202;
            --primary-gold: #c5a059;
            --blood-red: #8a0b0b;
            --text-grey: #a0a0a0;
        }

        body {
            background-color: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: 'MedievalSharp', cursive;
            overflow: hidden;
            background-image: radial-gradient(circle, #2b0808 0%, #000000 100%);
            user-select: none;
        }

        .phone-case {
            width: 380px;
            height: 800px;
            background: linear-gradient(135deg, #1f1f1f, #000);
            border-radius: 40px;
            padding: 15px;
            box-shadow: 
                0 0 20px rgba(138, 11, 11, 0.3),
                inset 0 0 10px rgba(0,0,0,0.8),
                0 0 0 5px #2a2a2a;
            position: relative;
            border: 2px solid #333;
            transition: all 0.5s ease;
        }

        /* --- MODE 1: FULL SCREEN (IMMERSIVE) --- */
        body.full-screen-mode .phone-case {
            width: 100vw; height: 100vh; border: none; border-radius: 0; padding: 0; box-shadow: none; background: none;
        }
        body.full-screen-mode .screen { border-radius: 0; }
        body.full-screen-mode .status-bar { display: none !important; }
        body.full-screen-mode .app-view { top: 0 !important; height: 100% !important; }
        body.full-screen-mode #home-screen { padding-top: 40px !important; }

        /* --- MODE 2: NO FRAME (DESKTOP) --- */
        body.no-frame-mode .phone-case {
            width: 100vw; height: 100vh; border: none; border-radius: 0; padding: 0; box-shadow: none; background: none;
        }
        body.no-frame-mode .screen { border-radius: 0; }

        .screen {
            width: 100%;
            height: 100%;
            background-color: var(--screen-bg);
            border-radius: 30px;
            position: relative;
            overflow: hidden;
            color: var(--primary-gold);
            background-image: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            display: flex;
            flex-direction: column;
            transition: border-radius 0.5s ease;
        }

        /* --- STATUS BAR LOGIC --- */
        .status-bar {
            height: 30px; 
            display: flex; justify-content: space-between; padding: 5px 20px;
            font-size: 14px; align-items: center; 
            background: #0a0202; /* Solid dark background for apps */
            z-index: 100; flex-shrink: 0;
            position: relative; 
            box-sizing: border-box;
            border-bottom: 1px solid #1a0505;
        }

        .screen.home-active .status-bar {
            position: absolute; 
            top: 0; left: 0; width: 100%;
            background: transparent; 
            border-bottom: none;
        }

        /* Apps */
        .app-view {
            position: absolute; 
            top: 30px; 
            bottom: 0; left: 0; width: 100%;
            background-color: var(--screen-bg); z-index: 10;
            display: none; flex-direction: column; box-sizing: border-box;
            animation: fadeIn 0.3s ease-out;
            background-size: cover; background-position: center; background-repeat: no-repeat;
        }
        .app-view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .app-header {
            height: 50px; padding: 0 15px; border-bottom: 2px solid var(--blood-red);
            display: flex; justify-content: center; align-items: center;
            font-family: 'UnifrakturMaguntia', cursive; font-size: 24px; letter-spacing: 2px;
            text-shadow: 0 0 5px var(--blood-red); background: rgba(0,0,0,0.8);
            flex-shrink: 0; position: relative;
        }

        #chat-title-name { font-size: 18px; font-family: 'MedievalSharp', cursive; letter-spacing: 1px; }
        
        .header-btn {
            position: absolute; background: none; border: 1px solid var(--primary-gold);
            color: var(--primary-gold); width: 32px; height: 32px; border-radius: 5px;
            cursor: pointer; font-size: 16px; display: flex; justify-content: center; align-items: center; z-index: 10;
        }
        .header-btn:hover { background: var(--blood-red); color: #000; }
        .btn-left { left: 15px; } .btn-right { right: 15px; }

        .app-content { flex: 1; overflow-y: auto; padding: 15px; position: relative; min-height: 0; padding-bottom: 20px; }
        .app-content::-webkit-scrollbar { width: 6px; }
        .app-content::-webkit-scrollbar-thumb { background: var(--blood-red); border-radius: 3px; }

        /* Home Screen */
        #home-screen {
            position: absolute; top: 0; bottom: 0; width: 100%;
            display: flex; flex-direction: column;
            padding: 40px 20px 20px 20px; 
            box-sizing: border-box; overflow-y: auto;
            align-items: center;
            background-size: cover; background-position: center;
        }
        
        /* Home Widgets */
        #home-widget-container {
            width: 100%; display: flex; flex-direction: column; align-items: center;
            margin-bottom: 40px; text-align: center; z-index: 5;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        #home-widget-clock { font-family: 'UnifrakturMaguntia', cursive; font-size: 64px; color: var(--primary-gold); margin-bottom: 10px; line-height: 1; }
        .home-avatar-container { width: 100px; height: 100px; position: relative; margin-bottom: 15px; }
        #home-widget-avatar {
            width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--blood-red);
            object-fit: cover; cursor: pointer; background: #000;
            box-shadow: 0 0 20px rgba(0,0,0,0.8); transition: transform 0.2s;
        }
        #home-widget-avatar:hover { transform: scale(1.05); border-color: var(--primary-gold); }
        #home-widget-signature {
            font-size: 14px; color: #ccc; font-style: italic; max-width: 90%; cursor: pointer; padding: 5px 10px; border-radius: 5px;
            background: transparent; text-shadow: 0 0 5px #000;
        }
        #home-widget-signature:hover { color: var(--primary-gold); }

        /* Grid Layout for 4 Apps */
        #home-apps-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 25px; /* 2 columns for 4 apps */
            width: 80%; justify-items: center; z-index: 5;
        }

        .app-icon { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.2s; }
        .app-icon:hover { transform: scale(1.1); }
        .icon-box {
            width: 60px; height: 60px; background: rgba(26, 5, 5, 0.9); border: 1px solid var(--primary-gold);
            border-radius: 15px; display: flex; justify-content: center; align-items: center;
            font-size: 24px; margin-bottom: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .icon-label { font-size: 12px; color: var(--text-grey); text-shadow: 0 0 4px #000; background: rgba(0,0,0,0.4); padding: 2px 5px; border-radius: 4px; }

        /* Controls */
        .goth-input, .goth-textarea, .goth-select {
            background: #000; border: 1px solid var(--primary-gold);
            color: var(--primary-gold); padding: 8px; border-radius: 4px;
            font-family: 'MedievalSharp', cursive; box-sizing: border-box; width: 100%;
        }
        .goth-btn {
            background: var(--blood-red); color: #000; border: none; padding: 8px 15px;
            cursor: pointer; font-family: 'MedievalSharp', cursive; font-weight: bold;
            border-radius: 4px; display: flex; justify-content: center; align-items: center; gap: 5px;
        }
        .btn-export { background: #333; color: var(--primary-gold); border: 1px solid var(--primary-gold); }
        .btn-delete { background: #500; color: #fff; border: 1px solid #f00; margin-top: 15px; }
        .goth-select option { background: #000; color: var(--primary-gold); }

        .upload-container { display: flex; align-items: center; gap: 15px; margin-bottom: 12px; }
        .avatar-preview {
            width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary-gold);
            background-color: #000; object-fit: cover;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23333"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>');
            background-size: 60%; background-repeat: no-repeat; background-position: center;
        }
        .bg-preview {
            width: 100%; height: 60px; border-radius: 4px; border: 2px solid var(--primary-gold);
            background-color: #000; object-fit: cover; display: block; margin-bottom: 5px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23333"><path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z"/></svg>');
            background-size: 30px; background-repeat: no-repeat; background-position: center; cursor: pointer;
        }
        .upload-btn {
            background: #111; color: #888; border: 1px dashed #666; padding: 5px 10px;
            font-size: 12px; cursor: pointer; border-radius: 4px;
        }
        .upload-btn:hover { border-color: var(--primary-gold); color: var(--primary-gold); }

        /* Contact List */
        .contact-item {
            background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 12px; margin-bottom: 10px;
            border-radius: 8px; display: flex; align-items: center; cursor: pointer; transition: border-color 0.2s;
        }
        .contact-item:hover { border-color: var(--primary-gold); background: rgba(197, 160, 89, 0.1); }
        .contact-avatar-img {
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover;
            border: 1px solid var(--blood-red); margin-right: 15px; background: #000;
        }
        .contact-info { flex: 1; }
        .contact-name { color: var(--primary-gold); font-size: 16px; margin-bottom: 2px; }
        .contact-preview { color: #666; font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px; }

        /* Chat View */
        .chat-view-container { 
            flex: 1; display: flex; flex-direction: column; min-height: 0; position: relative;
            background: rgba(10, 2, 2, 0.7); 
        }
        .chat-history { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .chat-input-area { display: flex; flex-direction: column; border-top: 1px solid #333; background: #0a0202; flex-shrink: 0; padding-bottom: 15px; }
        .input-toolbar { display: none; align-items: center; justify-content: space-between; padding: 5px 10px; background: #1a0505; border-bottom: 1px solid #333; font-size: 12px; color: #aaa; }
        .quote-preview-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 85%; font-style: italic; color: var(--primary-gold); }
        .input-row { display: flex; padding: 10px; }

        /* Multi-select */
        #multi-select-bar { display: none; padding: 10px; background: #111; border-top: 2px solid var(--blood-red); justify-content: space-between; align-items: center; }

        /* Chat Bubbles */
        .chat-row { display: flex; width: 100%; position: relative; }
        .chat-row.received { justify-content: flex-start; }
        .chat-row.sent { justify-content: flex-end; }
        
        .chat-avatar-small { width: 35px; height: 35px; border-radius: 50%; border: 1px solid #444; object-fit: cover; flex-shrink: 0; background: #000; }
        .chat-row.received .chat-avatar-small { margin-right: 8px; border-color: var(--blood-red); }
        .chat-row.sent .chat-avatar-small { margin-left: 8px; border-color: var(--primary-gold); }

        .msg-bubble {
            padding: 10px; border-radius: 8px; font-size: 14px; max-width: 70%; line-height: 1.4; word-wrap: break-word; position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5); transition: transform 0.1s;
        }
        .chat-row.received .msg-bubble { background: rgba(138, 11, 11, 0.4); border-left: 3px solid var(--blood-red); backdrop-filter: blur(5px); }
        .chat-row.sent .msg-bubble { background: rgba(197, 160, 89, 0.3); border-right: 3px solid var(--primary-gold); text-align: right; backdrop-filter: blur(5px); }
        .msg-bubble:active { transform: scale(0.98); }

        .quote-block { background: rgba(0,0,0,0.3); border-left: 2px solid #888; padding: 4px 8px; margin-bottom: 6px; font-size: 11px; color: #ccc; border-radius: 4px; text-align: left; white-space: pre-wrap; }
        .msg-recalled { background: rgba(50, 50, 50, 0.5) !important; border-color: #555 !important; color: #888; font-style: italic; cursor: pointer; }
        .msg-recalled:hover { color: #fff; }
        .select-checkbox { display: none; width: 20px; height: 20px; border: 1px solid var(--primary-gold); border-radius: 50%; margin-right: 10px; align-self: center; flex-shrink: 0; justify-content: center; align-items: center; }
        .chat-row.selecting .select-checkbox { display: flex; }
        .chat-row.selected .select-checkbox { background: var(--blood-red); }
        .chat-row.selected .select-checkbox::after { content: '✓'; color: #000; font-size: 14px; }
        .msg-error { color: #ff5555; font-family: monospace; border: 1px dashed #ff5555; background: rgba(50, 0, 0, 0.8) !important; }

        /* Context Menu */
        .context-menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: flex-end; }
        .context-menu { width: 100%; background: #111; border-top: 2px solid var(--primary-gold); border-radius: 20px 20px 0 0; padding: 20px; box-sizing: border-box; animation: slideUp 0.2s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .menu-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; text-align: center; }
        .menu-item { display: flex; flex-direction: column; align-items: center; gap: 8px; color: #ccc; cursor: pointer; }
        .menu-item i { font-size: 20px; background: #222; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; border-radius: 50%; border: 1px solid #444; }
        .menu-item:hover i { background: var(--primary-gold); color: #000; }
        .menu-item span { font-size: 11px; }

        /* Common Modal Stuff */
        .lore-entry { background: rgba(0,0,0,0.6); border: 1px solid #333; padding: 10px; margin-bottom: 10px; position: relative; padding-bottom: 35px; }
        .lore-header { display: flex; justify-content: space-between; align-items: center; }
        .lore-title { color: var(--blood-red); font-family: 'UnifrakturMaguntia', cursive; font-size: 18px; margin: 0; }
        .lore-scope-tag { font-size: 10px; padding: 2px 6px; border: 1px solid #444; border-radius: 4px; }
        .tag-global { background: #c5a059; color: #000; }
        .tag-local { background: #333; color: #aaa; }
        .lore-content { font-size: 12px; color: #888; white-space: pre-wrap; margin-top: 5px; }
        .lore-target { font-size: 10px; color: var(--primary-gold); margin-top: 5px; font-style: italic; }
        .lore-actions { position: absolute; right: 8px; bottom: 5px; display: flex; gap: 10px; }
        .icon-btn { background: none; border: none; cursor: pointer; color: #666; font-size: 14px; }
        
        .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { width: 85%; background: #111; border: 2px solid var(--blood-red); padding: 15px; border-radius: 10px; box-shadow: 0 0 20px rgba(138, 11, 11, 0.5); max-height: 90%; overflow-y: auto; }
        .modal-title { text-align: center; color: var(--primary-gold); margin-bottom: 15px; font-family: 'UnifrakturMaguntia', cursive; }
        .form-row { margin-bottom: 12px; }
        .form-label { display: block; color: #888; font-size: 12px; margin-bottom: 5px; }
        .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; gap: 10px; }
        .btn-cancel { background: #333; color: #888; width: 30%; }
        .btn-confirm { background: var(--primary-gold); color: #000; flex: 1; }

        .switch-container { display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; padding: 10px; border-radius: 4px; border: 1px solid #333; margin-bottom: 10px; }
        .switch-label { color: var(--primary-gold); font-size: 14px; }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: #888; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--blood-red); }
        input:checked + .slider:before { transform: translateX(20px); background-color: #fff; }

        .wb-checkbox-container { max-height: 100px; overflow-y: auto; border: 1px solid #333; padding: 5px; background: #0a0202; border-radius: 4px; }
        .wb-checkbox-item { display: flex; align-items: center; padding: 5px; border-bottom: 1px solid #1a1a1a; }
        .wb-checkbox-item:last-child { border-bottom: none; }
        .wb-checkbox-item label { color: #888; font-size: 14px; margin-left: 8px; cursor: pointer; width: 100%; }
        .wb-checkbox-item input { accent-color: var(--blood-red); cursor: pointer; }

        #modal-confirm-delete .modal-box { border-color: #f00; box-shadow: 0 0 30px rgba(255, 0, 0, 0.3); text-align: center; }
        .warn-text { color: #ccc; font-size: 14px; margin-bottom: 20px; line-height: 1.5; }
    </style>

    <style id="user-global-style"></style>
    <style id="user-font-style"></style>
    <style id="current-chat-style"></style>

</head>
<body>

    <div class="phone-case">
        <div class="screen">
            <!-- 状态栏 -->
            <div class="status-bar">
                <span id="carrier">NO SOUL</span>
                <span id="clock">00:00</span>
                <span id="battery-status"><i class="fas fa-battery-three-quarters"></i> 66%</span>
            </div>

            <!-- 主屏幕 -->
            <div id="home-screen">
                <!-- Home Widget Area -->
                <div id="home-widget-container">
                    <div id="home-widget-clock">00:00</div>
                    <div class="home-avatar-container">
                        <img id="home-widget-avatar" src="" onclick="document.getElementById('home-avatar-file').click()">
                        <input type="file" id="home-avatar-file" accept="image/*" style="display:none" onchange="handleHomeAvatarUpload(this)">
                    </div>
                    <div id="home-widget-signature" onclick="editHomeSignature()">我无限的爱着新的一日</div>
                </div>

                <!-- Apps Grid (2x2) -->
                <div id="home-apps-grid">
                    <div class="app-icon" onclick="openApp('app-chat')">
                        <div class="icon-box" style="color: #c5a059;"><i class="fas fa-comment-dots"></i></div>
                        <span class="icon-label">Whispers</span>
                    </div>
                    <div class="app-icon" onclick="openApp('app-world')">
                        <div class="icon-box" style="color: #8a0b0b;"><i class="fas fa-book-skull"></i></div>
                        <span class="icon-label">Grimoire</span>
                    </div>
                    <!-- NEW APP: VANITY (BEAUTIFY) -->
                    <div class="app-icon" onclick="openApp('app-beautify')">
                        <div class="icon-box" style="color: #bfa7cc;"><i class="fas fa-magic"></i></div>
                        <span class="icon-label">Vanity</span>
                    </div>
                    <div class="app-icon" onclick="openApp('app-settings')">
                        <div class="icon-box" style="color: #a0a0a0;"><i class="fas fa-cogs"></i></div>
                        <span class="icon-label">Pact</span>
                    </div>
                </div>
            </div>

            <!-- ================= WHISPERS ================= -->
            <div id="app-chat" class="app-view">
                <div class="app-header">
                    <button class="header-btn btn-left" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>
                    Whispers
                    <button class="header-btn btn-right" onclick="openAddContactModal()"><i class="fas fa-plus"></i></button>
                </div>
                <div class="app-content" id="contact-list"></div>
            </div>

            <!-- ================= CHAT CONVERSATION ================= -->
            <div id="app-chat-conversation" class="app-view">
                <div class="app-header">
                    <button class="header-btn btn-left" onclick="backToContactList()"><i class="fas fa-chevron-left"></i></button>
                    <span id="chat-title-name">Unknown</span>
                    <button class="header-btn btn-right" onclick="openChatSettingsModal()"><i class="fas fa-cog"></i></button>
                </div>
                <div class="chat-view-container">
                    <div class="chat-history" id="message-container"></div>
                    <div id="multi-select-bar">
                        <button class="goth-btn btn-cancel" onclick="exitSelectionMode()">Cancel</button>
                        <span style="color:#666; font-size:12px;">Select Messages</span>
                        <button class="goth-btn btn-delete" style="margin-top:0;" onclick="deleteSelectedMessages()">Delete</button>
                    </div>
                    <div class="chat-input-area" id="chat-input-wrapper">
                        <div id="quote-preview-bar" class="input-toolbar">
                            <span class="quote-preview-text" id="quote-preview-content">Replying to...</span>
                            <i class="fas fa-times" style="cursor:pointer; color:#888;" onclick="cancelQuote()"></i>
                        </div>
                        <div class="input-row">
                            <input type="text" id="msg-input" class="goth-input" placeholder="Whisper... (Empty to receive)">
                            <button class="goth-btn" style="margin-left:5px;" onclick="sendChatMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ================= CONTEXT MENUS & MODALS ================= -->
            <div id="context-menu-overlay" class="context-menu-overlay" onclick="closeContextMenu()">
                <div class="context-menu" onclick="event.stopPropagation()">
                    <div class="menu-grid">
                        <div class="menu-item" onclick="handleMenuAction('copy')"><i class="fas fa-copy"></i><span>Copy</span></div>
                        <div class="menu-item" onclick="handleMenuAction('quote')"><i class="fas fa-reply"></i><span>Quote</span></div>
                        <div class="menu-item" onclick="handleMenuAction('recall')"><i class="fas fa-undo"></i><span>Recall</span></div>
                        <div class="menu-item" onclick="handleMenuAction('multi')"><i class="fas fa-check-double"></i><span>Select</span></div>
                        <div class="menu-item" onclick="handleMenuAction('delete')" style="color:#ff5555;"><i class="fas fa-trash" style="border-color:#ff5555;"></i><span>Delete</span></div>
                    </div>
                </div>
            </div>

            <div id="modal-add-contact" class="modal-overlay">
                <div class="modal-box">
                    <h3 class="modal-title">Summon Entity</h3>
                    <div class="form-row">
                        <span class="form-label">Avatar</span>
                        <div class="upload-container">
                            <img id="new-contact-preview" class="avatar-preview" onclick="document.getElementById('new-contact-file').click()">
                            <input type="file" id="new-contact-file" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'new-contact-preview')">
                            <label class="upload-btn" onclick="document.getElementById('new-contact-file').click()">Select Image</label>
                        </div>
                    </div>
                    <div class="form-row"><span class="form-label">True Name</span><input type="text" id="new-contact-name" class="goth-input" placeholder="Name..."></div>
                    <div class="form-row"><span class="form-label">Persona</span><textarea id="new-contact-persona" class="goth-textarea" style="height: 100px;" placeholder="Who are they..."></textarea></div>
                    <div class="modal-actions">
                        <button class="goth-btn btn-cancel" onclick="closeModal('modal-add-contact')">Cancel</button>
                        <button class="goth-btn btn-confirm" onclick="saveNewContact()">Summon</button>
                    </div>
                </div>
            </div>

            <div id="modal-chat-settings" class="modal-overlay">
                <div class="modal-box">
                    <h3 class="modal-title">Soul Binding</h3>
                    <div style="display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 15px;">
                        <div style="flex: 1; text-align: center;"><span class="form-label">Entity</span><img id="setting-char-preview" class="avatar-preview" style="margin: 0 auto; display: block;" onclick="document.getElementById('setting-char-file').click()"><input type="file" id="setting-char-file" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'setting-char-preview')"></div>
                        <div style="flex: 1; text-align: center;"><span class="form-label">User</span><img id="setting-user-preview" class="avatar-preview" style="margin: 0 auto; display: block;" onclick="document.getElementById('setting-user-file').click()"><input type="file" id="setting-user-file" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'setting-user-preview')"></div>
                    </div>
                    <div class="form-row"><span class="form-label">Chat Background</span><img id="setting-bg-preview" class="bg-preview" onclick="document.getElementById('setting-bg-file').click()"><input type="file" id="setting-bg-file" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'setting-bg-preview', 800)"></div>
                    <div class="form-row"><span class="form-label">Entity Persona</span><textarea id="setting-char-persona" class="goth-textarea" style="height: 60px;"></textarea></div>
                    <div class="form-row"><span class="form-label">User Name</span><input type="text" id="setting-user-name" class="goth-input" placeholder="Your Name..."></div>
                    <div class="form-row"><span class="form-label">User Persona</span><textarea id="setting-user-persona" class="goth-textarea" style="height: 50px;" placeholder="Your role..."></textarea></div>
                    <div class="switch-container"><span class="switch-label">Offline Mode</span><label class="switch"><input type="checkbox" id="setting-offline-mode" onchange="toggleOfflineInput()"><span class="slider"></span></label></div>
                    <div id="offline-length-container" class="form-row" style="display: none; border-left: 2px solid var(--blood-red); padding-left: 10px;"><span class="form-label" style="color: var(--primary-gold);">Desired Output Length</span><input type="number" id="setting-target-length" class="goth-input" placeholder="e.g. 500" max="5000"></div>
                    <div class="form-row"><span class="form-label">Bubble CSS</span><textarea id="setting-bubble-css" class="goth-textarea" style="height: 50px; font-size: 10px; font-family: monospace;" placeholder=".msg-bubble { ... }"></textarea></div>
                    <div class="modal-actions">
                        <button class="goth-btn btn-export" onclick="exportCurrentChat()"><i class="fas fa-file-export"></i></button>
                        <button class="goth-btn btn-confirm" onclick="saveChatSettings()">Seal Pact</button>
                    </div>
                    <button class="goth-btn btn-delete" onclick="askDeleteContact()"><i class="fas fa-skull"></i> Delete Soul</button>
                    <button class="goth-btn btn-cancel" style="width:100%; margin-top:10px;" onclick="closeModal('modal-chat-settings')">Cancel</button>
                </div>
            </div>

            <div id="modal-confirm-delete" class="modal-overlay" style="z-index: 10000;">
                <div class="modal-box">
                    <h3 class="modal-title" style="color: #f00;">Sever Connection?</h3>
                    <p class="warn-text">This action allows the void to reclaim this soul.<br>All memories (chat history) will be lost forever.<br><br><b>Are you sure?</b></p>
                    <div class="modal-actions"><button class="goth-btn btn-cancel" onclick="cancelDelete()">Mercy</button><button class="goth-btn btn-delete" onclick="confirmDeleteContact()">Condemn</button></div>
                </div>
            </div>
            
            <div id="modal-wipe-all" class="modal-overlay" style="z-index: 10001;">
                <div class="modal-box" style="border-color: #f00; text-align: center;">
                    <h3 class="modal-title" style="color: #f00;">FINAL WARNING</h3>
                    <p class="warn-text">You are about to erase EVERYTHING.<br>Contacts, Lore, Settings, Memories.<br>This cannot be undone.<br><br><b>Are you absolutely certain?</b></p>
                    <div class="modal-actions"><button class="goth-btn btn-cancel" onclick="closeModal('modal-wipe-all')">Abort</button><button class="goth-btn btn-delete" onclick="confirmWipeData()">OBLITERATE</button></div>
                </div>
            </div>

            <!-- ================= GRIMOIRE (World Book) ================= -->
            <div id="app-world" class="app-view">
                <div class="app-header">
                    <button class="header-btn btn-left" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>
                    Grimoire
                    <button class="header-btn btn-right" onclick="openWorldBookModal()"><i class="fas fa-plus"></i></button>
                </div>
                <div class="app-content" id="world-book-list"></div>
            </div>

            <div id="wb-modal" class="modal-overlay">
                <div class="modal-box">
                    <h3 class="modal-title" id="wb-modal-title">Inscribe Lore</h3>
                    <div class="form-row"><input type="text" id="wb-title" class="goth-input" placeholder="Keyword (Title)"></div>
                    <div class="form-row"><textarea id="wb-content" class="goth-textarea" style="height: 80px;" placeholder="Definition..."></textarea></div>
                    <div class="form-row" style="color: #aaa; font-size: 14px; display: flex; gap: 15px;">
                        <label><input type="radio" name="scope" value="global" checked onclick="toggleWbScope()"> Global</label>
                        <label><input type="radio" name="scope" value="local" onclick="toggleWbScope()"> Local</label>
                    </div>
                    <div class="form-row" id="wb-target-div" style="display: none;"><span class="form-label">Select Souls</span><div class="wb-checkbox-container" id="wb-target-list"></div></div>
                    <div class="modal-actions"><button class="goth-btn btn-cancel" onclick="closeModal('wb-modal')">Cancel</button><button class="goth-btn btn-confirm" onclick="saveWorldBookEntry()">Inscribe</button></div>
                </div>
            </div>

            <!-- ================= NEW APP: VANITY (BEAUTIFY) ================= -->
            <div id="app-beautify" class="app-view">
                <div class="app-header">
                    <button class="header-btn btn-left" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>
                    Vanity
                </div>
                <div class="app-content">
                    <div class="setting-group">
                        <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">Display Mode</label>
                        <button class="goth-btn" onclick="toggleFullScreenMode()"><i class="fas fa-expand"></i> Full Screen (Immersive)</button>
                        <button class="goth-btn" style="margin-top: 10px;" onclick="toggleNoFrameMode()"><i class="fas fa-border-none"></i> No Frame Only (Keep Status Bar)</button>
                    </div>

                    <div class="setting-group" style="margin-top: 25px;">
                        <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">Home Screen Background</label>
                        <div class="upload-container">
                            <img id="setting-home-bg-preview" class="bg-preview" onclick="document.getElementById('setting-home-bg-file').click()">
                            <input type="file" id="setting-home-bg-file" accept="image/*" style="display:none" onchange="handleImageUpload(this, 'setting-home-bg-preview', 800)">
                        </div>
                        <button class="goth-btn btn-export" onclick="resetHomeBg()" style="font-size:12px; padding:5px 10px;">Reset Background</button>
                    </div>

                    <div class="setting-group" style="margin-top: 25px;">
                        <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">System Font</label>
                        <input type="text" id="global-font-url" class="goth-input" placeholder="Import URL (e.g. Google Fonts)..." style="margin-bottom: 5px;">
                        <input type="text" id="global-font-family" class="goth-input" placeholder="Font Family (e.g. 'Roboto', sans-serif)">
                    </div>

                    <div class="setting-group" style="margin-top: 25px;">
                        <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">Global Visual Seal (CSS)</label>
                        <textarea id="global-css-input" class="goth-textarea" style="height: 120px; font-family: monospace; font-size: 10px;" placeholder="body { background: blue; }"></textarea>
                    </div>

                    <button class="goth-btn" style="margin-top: 30px;" onclick="saveVisualSettings()">Save Visuals</button>
                </div>
            </div>

            <!-- ================= PACT (SETTINGS) ================= -->
            <div id="app-settings" class="app-view">
                <div class="app-header">
                    <button class="header-btn btn-left" onclick="goHome()"><i class="fas fa-chevron-left"></i></button>
                    Pact
                </div>
                <div class="app-content">
                    <div class="setting-group">
                        <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">API URL</label>
                        <input type="text" id="global-api-url" class="goth-input" placeholder="https://api.openai.com/v1">
                    </div>
                    <div class="setting-group" style="margin-top: 15px;">
                        <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">API Key</label>
                        <input type="password" id="global-api-key" class="goth-input" placeholder="sk-...">
                    </div>
                    <div class="setting-group" style="margin-top: 15px; display:flex; align-items:flex-end; gap:10px;">
                        <div style="flex:1;">
                            <label class="form-label" style="font-size: 14px; color: var(--primary-gold);">Model Selection</label>
                            <select id="global-model-select" class="goth-select">
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo (Default)</option>
                            </select>
                        </div>
                        <button class="goth-btn" style="height: 38px; width: 40px; padding:0;" onclick="fetchModels()" title="Fetch Available Models"><i class="fas fa-sync-alt"></i></button>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
                        <button class="goth-btn" onclick="saveConnectionSettings()">Save Connection</button>
                        
                        <button class="goth-btn btn-export" onclick="exportAllData()" style="border-color: var(--blood-red); color: var(--blood-red); margin-top: 20px;">
                            <i class="fas fa-download"></i> Extract Soul Core
                        </button>
                        <button class="goth-btn btn-export" onclick="document.getElementById('import-file').click()">
                            <i class="fas fa-file-import"></i> Import Soul Core
                        </button>
                        <input type="file" id="import-file" accept=".json" style="display:none" onchange="handleImport(this)">

                        <button class="goth-btn btn-delete" style="margin-top: 30px;" onclick="askWipeData()">
                            <i class="fas fa-skull"></i> OBLITERATE ALL DATA
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <canvas id="img-compress-canvas" style="display: none;"></canvas>

    <script>
        let contacts = []; 
        let worldBook = [];
        let currentChatId = null;
        let wbEditIndex = -1;
        let tempImgData = { char: null, user: null, newChar: null, chatBg: null, homeBg: null };
        let homePrefs = { avatar: null, signature: "我无限的爱着新的一日", background: null };
        
        let pressTimer;
        let selectedMessageId = null;
        let quoteMessageId = null;
        let isSelectionMode = false;
        let selectedMessages = new Set();

        function uuidv4() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        window.onload = function() {
            loadData(); renderContactList(); renderWorldBook(); 
            updateClock(); setInterval(updateClock, 1000);
            initBattery();
            
            // Initialize in Home Mode
            document.querySelector('.screen').classList.add('home-active');

            document.getElementById('msg-input').addEventListener('keypress', function(e){ if(e.key === 'Enter') sendChatMessage(); });
            document.addEventListener('click', (e) => {
                if(!e.target.closest('.msg-bubble') && !e.target.closest('.context-menu')) {
                    closeContextMenu();
                }
            });
        };

        function loadData() {
            try { 
                const cData = localStorage.getItem('gothic_contacts'); 
                if(cData) contacts = JSON.parse(cData); 
                contacts.forEach(c => {
                    c.messages.forEach(m => { if(!m.id) m.id = uuidv4(); });
                });
            } catch(e) { contacts = []; }
            try { const wData = localStorage.getItem('gothic_worldbook'); if(wData) worldBook = JSON.parse(wData); } catch(e) { worldBook = []; }
            
            // Load Home Prefs
            try { 
                const hData = localStorage.getItem('gothic_home_prefs'); 
                if(hData) homePrefs = { ...homePrefs, ...JSON.parse(hData) }; 
            } catch(e) {}
            
            // Apply Home Prefs
            if(homePrefs.avatar) document.getElementById('home-widget-avatar').src = homePrefs.avatar;
            else document.getElementById('home-widget-avatar').src = "data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23333'><circle cx='12' cy='12' r='12'/></svg>";
            
            document.getElementById('home-widget-signature').innerText = homePrefs.signature;
            
            if(homePrefs.background) {
                document.getElementById('home-screen').style.backgroundImage = `url(${homePrefs.background})`;
                document.getElementById('setting-home-bg-preview').style.backgroundImage = `url(${homePrefs.background})`;
                document.getElementById('setting-home-bg-preview').style.backgroundSize = "cover";
            } else {
                 document.getElementById('setting-home-bg-preview').style.backgroundImage = "";
                 document.getElementById('setting-home-bg-preview').style.backgroundSize = "";
            }

            const url = localStorage.getItem('gothic_api_url');
            if(url) document.getElementById('global-api-url').value = url;
            
            const key = localStorage.getItem('gothic_api_key');
            if(key) document.getElementById('global-api-key').value = key;
            
            const gCss = localStorage.getItem('gothic_global_css');
            if(gCss) { document.getElementById('global-css-input').value = gCss; document.getElementById('user-global-style').innerHTML = gCss; }
            
            const savedModel = localStorage.getItem('gothic_api_model');
            if (savedModel) {
                const select = document.getElementById('global-model-select');
                if (!select.querySelector(`option[value="${savedModel}"]`)) {
                    const opt = document.createElement('option');
                    opt.value = savedModel; opt.innerText = savedModel; select.appendChild(opt);
                }
                select.value = savedModel;
            }

            const fUrl = localStorage.getItem('gothic_font_url');
            const fFam = localStorage.getItem('gothic_font_family');
            if(fUrl) document.getElementById('global-font-url').value = fUrl;
            if(fFam) document.getElementById('global-font-family').value = fFam;
            applyFontSettings(fUrl, fFam);

            // --- LOAD DISPLAY MODE ---
            const savedMode = localStorage.getItem('gothic_display_mode');
            if (savedMode === 'fullscreen') {
                document.body.classList.add('full-screen-mode');
            } else if (savedMode === 'noframe') {
                document.body.classList.add('no-frame-mode');
            }
        }
        function saveData() { localStorage.setItem('gothic_contacts', JSON.stringify(contacts)); localStorage.setItem('gothic_worldbook', JSON.stringify(worldBook)); }
        function saveHomePrefs() { localStorage.setItem('gothic_home_prefs', JSON.stringify(homePrefs)); }

        function applyFontSettings(url, family) {
            let link = document.getElementById('custom-font-link');
            if(!link) {
                link = document.createElement('link'); link.id = 'custom-font-link'; link.rel = 'stylesheet'; document.head.appendChild(link);
            }
            link.href = url || '';
            const style = document.getElementById('user-font-style');
            if(family) {
                style.innerHTML = `body, .goth-input, .goth-textarea, .goth-select, .goth-btn, .contact-name, .msg-bubble { font-family: ${family} !important; }`;
            } else { style.innerHTML = ''; }
        }

        function initBattery() {
            if(navigator.getBattery) {
                navigator.getBattery().then(function(battery) {
                    updateBatteryUI(battery);
                    battery.addEventListener('levelchange', () => updateBatteryUI(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryUI(battery));
                });
            }
        }
        function updateBatteryUI(battery) {
            const level = Math.round(battery.level * 100);
            const isCharging = battery.charging;
            let icon = 'fa-battery-full';
            if(level < 90) icon = 'fa-battery-three-quarters';
            if(level < 60) icon = 'fa-battery-half';
            if(level < 30) icon = 'fa-battery-quarter';
            if(level < 10) icon = 'fa-battery-empty';
            if(isCharging) icon = 'fa-bolt';
            const el = document.getElementById('battery-status');
            el.innerHTML = `<i class="fas ${icon}"></i> ${level}%`;
            if(level < 20 && !isCharging) el.style.color = '#ff3333';
            else el.style.color = '';
        }

        function handleImageUpload(input, previewId, maxSize = 500) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.getElementById('img-compress-canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width; let height = img.height;
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                        canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.95); 
                        document.getElementById(previewId).src = dataUrl;
                        if(previewId === 'new-contact-preview') tempImgData.newChar = dataUrl;
                        if(previewId === 'setting-char-preview') tempImgData.char = dataUrl;
                        if(previewId === 'setting-user-preview') tempImgData.user = dataUrl;
                        if(previewId === 'setting-bg-preview') tempImgData.chatBg = dataUrl;
                        if(previewId === 'setting-home-bg-preview') { 
                            tempImgData.homeBg = dataUrl; 
                            document.getElementById('setting-home-bg-preview').style.backgroundImage = `url(${dataUrl})`;
                            document.getElementById('setting-home-bg-preview').style.backgroundSize = "cover";
                        }
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleHomeAvatarUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.getElementById('img-compress-canvas');
                        const ctx = canvas.getContext('2d');
                        let width = img.width; let height = img.height;
                        let maxSize = 500;
                        if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } } 
                        else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                        canvas.width = width; canvas.height = height; ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.95); 
                        
                        homePrefs.avatar = dataUrl;
                        document.getElementById('home-widget-avatar').src = dataUrl;
                        saveHomePrefs();
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function editHomeSignature() {
            const current = homePrefs.signature;
            const newSig = prompt("Edit Signature:", current);
            if(newSig !== null) {
                homePrefs.signature = newSig;
                document.getElementById('home-widget-signature').innerText = newSig;
                saveHomePrefs();
            }
        }

        function resetHomeBg() {
            homePrefs.background = null;
            document.getElementById('home-screen').style.backgroundImage = "";
            document.getElementById('setting-home-bg-preview').style.backgroundImage = "";
            tempImgData.homeBg = null;
            saveHomePrefs();
        }

        function openApp(appId) {
            document.getElementById('home-screen').style.display = 'none';
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            
            // --- DISABLE HOME MODE (RESTORE SOLID STATUS BAR) ---
            document.querySelector('.screen').classList.remove('home-active');

            if(appId === 'app-chat') {
                document.getElementById('app-chat').classList.add('active');
                document.getElementById('app-chat-conversation').classList.remove('active');
                renderContactList();
            } else {
                document.getElementById(appId).classList.add('active');
                if(appId === 'app-world') renderWorldBook();
            }
        }

        function goHome() {
            document.querySelectorAll('.app-view').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.modal-overlay').forEach(el => el.style.display = 'none');
            document.getElementById('home-screen').style.display = 'flex'; // Changed to flex for vertical layout
            
            // --- ENABLE HOME MODE (TRANSPARENT STATUS BAR) ---
            document.querySelector('.screen').classList.add('home-active');

            document.getElementById('current-chat-style').innerHTML = '';
            document.getElementById('app-chat-conversation').style.backgroundImage = '';
            exitSelectionMode();
            cancelQuote();
            currentChatId = null;
        }
        function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

        function openAddContactModal() {
            document.getElementById('new-contact-name').value = '';
            document.getElementById('new-contact-persona').value = '';
            document.getElementById('new-contact-preview').src = "";
            tempImgData.newChar = null;
            document.getElementById('modal-add-contact').style.display = 'flex';
        }
        function saveNewContact() {
            const name = document.getElementById('new-contact-name').value.trim();
            const persona = document.getElementById('new-contact-persona').value.trim();
            if(!name) { alert("Name required."); return; }
            const newContact = { 
                id: Date.now(), name: name, persona: persona, 
                avatar: tempImgData.newChar || null, userAvatar: null, chatBackground: null,
                userName: "", userPersona: "", maxTokens: 1000,
                offlineMode: false, targetLength: "", bubbleCss: "", messages: [] 
            };
            contacts.push(newContact); saveData(); closeModal('modal-add-contact'); renderContactList();
        }
        function renderContactList() {
            const list = document.getElementById('contact-list'); list.innerHTML = '';
            if(contacts.length === 0) { list.innerHTML = '<div style="text-align:center;color:#666;margin-top:50px;">No souls found...<br>Summon one (+)</div>'; return; }
            contacts.forEach(c => {
                const div = document.createElement('div'); div.className = 'contact-item'; div.onclick = () => openChat(c.id);
                let lastMsg = "Empty void..."; 
                if(c.messages.length > 0) {
                    const last = c.messages[c.messages.length - 1];
                    lastMsg = last.content;
                    if(last.isRecalled) lastMsg = last.role === 'user' ? "You recalled a message" : "Entity recalled a message";
                }
                let avatarHtml = `<div class="contact-avatar-img" style="display:flex;justify-content:center;align-items:center;font-size:18px;color:#666;">${c.name[0]}</div>`;
                if(c.avatar) avatarHtml = `<img src="${c.avatar}" class="contact-avatar-img">`;
                div.innerHTML = `${avatarHtml}<div class="contact-info"><div class="contact-name">${escapeHtml(c.name)}</div><div class="contact-preview">${escapeHtml(lastMsg)}</div></div>`;
                list.appendChild(div);
            });
        }

        function openChat(id) {
            currentChatId = id; const contact = contacts.find(c => c.id === id); if(!contact) return;
            document.getElementById('app-chat').classList.remove('active');
            const chatView = document.getElementById('app-chat-conversation');
            chatView.classList.add('active');
            if (contact.chatBackground) chatView.style.backgroundImage = `url(${contact.chatBackground})`;
            else chatView.style.backgroundImage = '';
            document.getElementById('chat-title-name').innerText = contact.name;
            if(contact.bubbleCss) document.getElementById('current-chat-style').innerHTML = contact.bubbleCss; else document.getElementById('current-chat-style').innerHTML = '';
            renderMessages(contact);
        }
        function backToContactList() {
            currentChatId = null; document.getElementById('current-chat-style').innerHTML = '';
            document.getElementById('app-chat-conversation').style.backgroundImage = '';
            document.getElementById('app-chat-conversation').classList.remove('active');
            document.getElementById('app-chat').classList.add('active');
            exitSelectionMode();
            cancelQuote();
            renderContactList();
        }

        function renderMessages(contact) {
            const container = document.getElementById('message-container'); container.innerHTML = '';
            const charAvatarSrc = contact.avatar || ""; const userAvatarSrc = contact.userAvatar || "";
            const charFallback = `<div class="chat-avatar-small" style="display:flex;align-items:center;justify-content:center;color:#aaa;">${contact.name[0]}</div>`;
            const userFallback = `<div class="chat-avatar-small" style="display:flex;align-items:center;justify-content:center;color:#aaa;"><i class="fas fa-user"></i></div>`;
            
            contact.messages.forEach(msg => {
                const isUser = msg.role === 'user';
                const row = document.createElement('div'); 
                row.className = `chat-row ${isUser ? 'sent' : 'received'}`;
                if(isSelectionMode) {
                    row.classList.add('selecting');
                    if(selectedMessages.has(msg.id)) row.classList.add('selected');
                    row.onclick = () => toggleSelectMessage(msg.id);
                }

                const checkbox = document.createElement('div'); checkbox.className = 'select-checkbox';
                let leftAvatar = ''; if(!isUser) leftAvatar = charAvatarSrc ? `<img src="${charAvatarSrc}" class="chat-avatar-small">` : charFallback;
                let rightAvatar = ''; if(isUser) rightAvatar = userAvatarSrc ? `<img src="${userAvatarSrc}" class="chat-avatar-small">` : userFallback;
                
                let contentHtml = "";
                let bubbleClass = "msg-bubble";

                if (msg.isRecalled) {
                    bubbleClass += " msg-recalled";
                    contentHtml = isUser ? "You recalled a message" : "Entity recalled a message";
                } else {
                    if (msg.role === 'system' || msg.content.includes("[CONNECTION SEVERED]")) bubbleClass += " msg-error";
                    
                    if (msg.quoteId) {
                        const originalMsg = contact.messages.find(m => m.id === msg.quoteId);
                        if (originalMsg) {
                            let qText = originalMsg.isRecalled ? "Message recalled" : originalMsg.content;
                            if(qText.length > 50) qText = qText.substring(0, 50) + "...";
                            const qUser = originalMsg.role === 'user' ? "You" : contact.name;
                            contentHtml += `<div class="quote-block"><b>${qUser}:</b> ${escapeHtml(qText)}</div>`;
                        }
                    }
                    contentHtml += escapeHtml(msg.content);
                }

                const bubble = document.createElement('div');
                bubble.className = bubbleClass;
                bubble.innerHTML = contentHtml;

                if(!isSelectionMode) {
                    bubble.addEventListener('mousedown', () => startPress(msg.id));
                    bubble.addEventListener('touchstart', () => startPress(msg.id));
                    bubble.addEventListener('mouseup', cancelPress);
                    bubble.addEventListener('touchend', cancelPress);
                    bubble.addEventListener('mouseleave', cancelPress);
                    if(msg.isRecalled) {
                        bubble.onclick = () => alert(`Original Content:\n\n${msg.recalledContent}`);
                    }
                }

                row.appendChild(checkbox);
                if(!isUser) row.innerHTML += leftAvatar;
                row.appendChild(bubble);
                if(isUser) row.innerHTML += rightAvatar;
                container.appendChild(row);
            });
            container.scrollTop = container.scrollHeight;
        }

        function startPress(id) { pressTimer = setTimeout(() => { showContextMenu(id); }, 500); }
        function cancelPress() { clearTimeout(pressTimer); }
        function showContextMenu(id) { selectedMessageId = id; document.getElementById('context-menu-overlay').style.display = 'flex'; if(navigator.vibrate) navigator.vibrate(50); }
        function closeContextMenu() { document.getElementById('context-menu-overlay').style.display = 'none'; selectedMessageId = null; }
        function handleMenuAction(action) {
            if(!currentChatId || !selectedMessageId) return;
            const contact = contacts.find(c => c.id === currentChatId);
            const msgIndex = contact.messages.findIndex(m => m.id === selectedMessageId);
            const msg = contact.messages[msgIndex];

            switch(action) {
                case 'copy': if(!msg.isRecalled) { navigator.clipboard.writeText(msg.content); alert("Copied"); } break;
                case 'quote': if(!msg.isRecalled) setQuote(msg); break;
                case 'delete': if(confirm("Delete this message?")) { contact.messages.splice(msgIndex, 1); saveData(); renderMessages(contact); } break;
                case 'recall': if(!msg.isRecalled) { msg.isRecalled = true; msg.recalledContent = msg.content; saveData(); renderMessages(contact); } break;
                case 'multi': enterSelectionMode(); toggleSelectMessage(selectedMessageId); break;
            }
            closeContextMenu();
        }

        function setQuote(msg) { quoteMessageId = msg.id; const bar = document.getElementById('quote-preview-bar'); const txt = document.getElementById('quote-preview-content'); let content = msg.content; if(content.length > 30) content = content.substring(0, 30) + "..."; txt.innerText = `Replying to: "${content}"`; bar.style.display = 'flex'; }
        function cancelQuote() { quoteMessageId = null; document.getElementById('quote-preview-bar').style.display = 'none'; }
        function enterSelectionMode() { isSelectionMode = true; selectedMessages.clear(); document.getElementById('multi-select-bar').style.display = 'flex'; document.getElementById('chat-input-wrapper').style.display = 'none'; const contact = contacts.find(c => c.id === currentChatId); renderMessages(contact); }
        function exitSelectionMode() { isSelectionMode = false; selectedMessages.clear(); document.getElementById('multi-select-bar').style.display = 'none'; document.getElementById('chat-input-wrapper').style.display = 'flex'; const contact = contacts.find(c => c.id === currentChatId); if(contact) renderMessages(contact); }
        function toggleSelectMessage(id) { if(selectedMessages.has(id)) selectedMessages.delete(id); else selectedMessages.add(id); const contact = contacts.find(c => c.id === currentChatId); renderMessages(contact); }
        function deleteSelectedMessages() { if(selectedMessages.size === 0) return; if(confirm(`Delete ${selectedMessages.size} messages?`)) { const contact = contacts.find(c => c.id === currentChatId); contact.messages = contact.messages.filter(m => !selectedMessages.has(m.id)); saveData(); exitSelectionMode(); } }

        function sendChatMessage() {
            if(!currentChatId) return;
            const input = document.getElementById('msg-input'); 
            const text = input.value.trim(); 
            const contact = contacts.find(c => c.id === currentChatId);
            if(text) {
                const newMsg = { id: uuidv4(), role: 'user', content: text, quoteId: quoteMessageId };
                contact.messages.push(newMsg); 
                saveData(); cancelQuote(); input.value = ''; renderMessages(contact); 
                return; 
            }
            requestAiReply(contact);
        }

        function requestAiReply(contact) {
            const container = document.getElementById('message-container');
            const row = document.createElement('div'); row.className = 'chat-row received'; row.id = 'temp-loading';
            const charAvatarSrc = contact.avatar || "";
            const charFallback = `<div class="chat-avatar-small" style="display:flex;align-items:center;justify-content:center;color:#aaa;">${contact.name[0]}</div>`;
            const avatarHtml = charAvatarSrc ? `<img src="${charAvatarSrc}" class="chat-avatar-small">` : charFallback;
            row.innerHTML = `${avatarHtml}<div class="msg-bubble"><i class="fas fa-ellipsis-h" style="animation: blink 1.5s infinite"></i></div>`;
            container.appendChild(row); container.scrollTop = container.scrollHeight;
            
            fetchAiResponse(contact).then(async responseContent => {
                const temp = document.getElementById('temp-loading'); if(temp) temp.remove();
                let parts = responseContent.includes('|||') ? responseContent.split('|||').map(p => p.trim()).filter(p => p.length > 0) : [responseContent];
                for (let i = 0; i < parts.length; i++) {
                    contact.messages.push({ id: uuidv4(), role: 'assistant', content: parts[i] });
                    saveData();
                    if(document.getElementById('app-chat-conversation').classList.contains('active')) { renderMessages(contact); }
                    if (i < parts.length - 1) {
                        if(document.getElementById('app-chat-conversation').classList.contains('active')) {
                            const typeId = 'typing-' + Date.now();
                            const container = document.getElementById('message-container');
                            const row = document.createElement('div'); row.className = 'chat-row received'; row.id = typeId;
                            row.innerHTML = `${avatarHtml}<div class="msg-bubble"><i class="fas fa-ellipsis-h" style="animation: blink 1.5s infinite"></i></div>`;
                            container.appendChild(row); container.scrollTop = container.scrollHeight;
                            await new Promise(resolve => setTimeout(resolve, 800 + Math.min(parts[i+1].length * 50, 2000)));
                            const typeEl = document.getElementById(typeId); if(typeEl) typeEl.remove();
                        } else { await new Promise(resolve => setTimeout(resolve, 1500)); }
                    }
                }
            }).catch(err => {
                const temp = document.getElementById('temp-loading'); if(temp) temp.remove();
                contact.messages.push({ id: uuidv4(), role: 'assistant', content: `[CONNECTION SEVERED] ${err.message}` });
                saveData(); renderMessages(contact);
            });
        }

        async function fetchAiResponse(contact) {
            const apiUrl = localStorage.getItem('gothic_api_url');
            const apiKey = localStorage.getItem('gothic_api_key');
            const apiModel = localStorage.getItem('gothic_api_model') || "gpt-3.5-turbo";
            if (!apiUrl || !apiKey) throw new Error("Pact Unsealed.");
            let systemPrompt = `[System: You MUST reply in Simplified Chinese (简体中文).]\nYou are ${contact.name}.\nPersona: ${contact.persona}\n`;
            if(contact.userName) systemPrompt += `User Name: ${contact.userName}\nUser Persona: ${contact.userPersona}\n`;
            let requestedTokens = 500; 
            if (contact.offlineMode) {
                let targetWords = contact.targetLength || 500;
                systemPrompt += `\n[MODE: OFFLINE / NOVEL ROLEPLAY]\n1. Output a SINGLE, CONTINUOUS narrative block.\n2. Enclose dialogue in double quotes.\n3. Length: ~${targetWords} words.\n4. Complete scene.\n5. Third Person perspective for ${contact.name}, Second Person for User.\n`;
                requestedTokens = Math.min(Math.ceil(targetWords * 3) + 500, 4000); 
            } else {
                systemPrompt += `\n[MODE: ONLINE / SMS]\n1. Multiple short messages separated by '|||'.\n2. Tone: Casual.\n`;
                requestedTokens = 800;
            }
            systemPrompt += `\n[World Info]\n`;
            let hasLore = false;
            worldBook.forEach(w => {
                let isRelevant = (w.scope === 'global') || (w.scope === 'local' && (Array.isArray(w.target) ? w.target : [w.target]).includes(contact.name));
                if (isRelevant) { systemPrompt += `${w.title}: ${w.content}\n`; hasLore = true; }
            });
            if(!hasLore) systemPrompt += "None.\n";
            const contextMessages = contact.messages.filter(m => !m.content.includes("[CONNECTION SEVERED]") && !m.isRecalled).slice(-10).map(m => {
                let text = m.content;
                if(m.quoteId) { const original = contact.messages.find(om => om.id === m.quoteId); if(original && !original.isRecalled) text = `[Replying to: "${original.content}"]\n${text}`; }
                return { role: m.role, content: text };
            });
            const payload = { model: apiModel, messages: [ { role: "system", content: systemPrompt }, ...contextMessages ], max_tokens: requestedTokens, temperature: 0.8 };
            const res = await fetch(`${apiUrl}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify(payload) });
            if (!res.ok) throw new Error(`API Error ${res.status}`);
            const data = await res.json();
            if(data.choices && data.choices.length > 0) return data.choices[0].message.content; else throw new Error("Empty choices.");
        }

        function toggleOfflineInput() { document.getElementById('offline-length-container').style.display = document.getElementById('setting-offline-mode').checked ? 'block' : 'none'; }
        function openChatSettingsModal() {
            if(!currentChatId) return;
            const contact = contacts.find(c => c.id === currentChatId);
            document.getElementById('setting-char-persona').value = contact.persona || '';
            document.getElementById('setting-user-name').value = contact.userName || ''; 
            document.getElementById('setting-user-persona').value = contact.userPersona || '';
            document.getElementById('setting-bubble-css').value = contact.bubbleCss || '';
            document.getElementById('setting-offline-mode').checked = contact.offlineMode || false;
            document.getElementById('setting-target-length').value = contact.targetLength || '';
            toggleOfflineInput(); 
            tempImgData.char = null; tempImgData.user = null; tempImgData.chatBg = null;
            document.getElementById('setting-char-preview').src = contact.avatar || "";
            document.getElementById('setting-user-preview').src = contact.userAvatar || "";
            const bgPreview = document.getElementById('setting-bg-preview');
            if (contact.chatBackground) { bgPreview.style.backgroundImage = `url(${contact.chatBackground})`; bgPreview.style.backgroundSize = "cover"; } else { bgPreview.style.backgroundImage = ""; bgPreview.style.backgroundSize = ""; }
            document.getElementById('modal-chat-settings').style.display = 'flex';
        }
        function saveChatSettings() {
            if(!currentChatId) return;
            const contact = contacts.find(c => c.id === currentChatId);
            contact.persona = document.getElementById('setting-char-persona').value;
            contact.userName = document.getElementById('setting-user-name').value.trim();
            contact.userPersona = document.getElementById('setting-user-persona').value;
            contact.bubbleCss = document.getElementById('setting-bubble-css').value;
            if(tempImgData.char) contact.avatar = tempImgData.char;
            if(tempImgData.user) contact.userAvatar = tempImgData.user;
            if(tempImgData.chatBg) contact.chatBackground = tempImgData.chatBg;
            contact.offlineMode = document.getElementById('setting-offline-mode').checked;
            let len = parseInt(document.getElementById('setting-target-length').value);
            if(isNaN(len)) len = 0; if(len > 5000) len = 5000;
            contact.targetLength = len;
            document.getElementById('current-chat-style').innerHTML = contact.bubbleCss;
            saveData();
            if(document.getElementById('app-chat-conversation').classList.contains('active')) {
                renderMessages(contact);
                const chatView = document.getElementById('app-chat-conversation');
                if (contact.chatBackground) chatView.style.backgroundImage = `url(${contact.chatBackground})`;
            }
            closeModal('modal-chat-settings');
        }
        function askDeleteContact() { document.getElementById('modal-chat-settings').style.display = 'none'; document.getElementById('modal-confirm-delete').style.display = 'flex'; }
        function cancelDelete() { document.getElementById('modal-confirm-delete').style.display = 'none'; document.getElementById('modal-chat-settings').style.display = 'flex'; }
        function confirmDeleteContact() { if(!currentChatId) return; contacts = contacts.filter(c => c.id !== currentChatId); saveData(); closeModal('modal-confirm-delete'); backToContactList(); }
        
        function exportCurrentChat() {
            if(!currentChatId) return;
            const contact = contacts.find(c => c.id === currentChatId);
            const exportData = { name: contact.name, exportDate: new Date().toISOString(), messages: contact.messages };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `whispers_${contact.name}.json`; a.click(); URL.revokeObjectURL(url);
        }
        function exportAllData() {
            const backup = { date: new Date().toISOString(), contacts, worldBook, globalSettings: { apiUrl: localStorage.getItem('gothic_api_url'), globalCss: localStorage.getItem('gothic_global_css') }, homePrefs };
            const blob = new Blob([JSON.stringify(backup, null, 2)], {type : 'application/json'});
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `gothic_full_backup.json`; a.click(); URL.revokeObjectURL(url);
        }

        // --- NEW SAVE FUNCTIONS ---

        function saveConnectionSettings() {
            const url = document.getElementById('global-api-url').value;
            const key = document.getElementById('global-api-key').value;
            const model = document.getElementById('global-model-select').value;
            localStorage.setItem('gothic_api_url', url);
            localStorage.setItem('gothic_api_key', key);
            localStorage.setItem('gothic_api_model', model);
            alert("Connection established.");
        }

        function saveVisualSettings() {
            const css = document.getElementById('global-css-input').value;
            const fontUrl = document.getElementById('global-font-url').value;
            const fontFam = document.getElementById('global-font-family').value;
            
            localStorage.setItem('gothic_global_css', css);
            localStorage.setItem('gothic_font_url', fontUrl);
            localStorage.setItem('gothic_font_family', fontFam);
            
            document.getElementById('user-global-style').innerHTML = css;
            applyFontSettings(fontUrl, fontFam);
            
            // Save Home BG if changed
            if(tempImgData.homeBg) {
                homePrefs.background = tempImgData.homeBg;
                saveHomePrefs();
                document.getElementById('home-screen').style.backgroundImage = `url(${homePrefs.background})`;
            }

            alert("Visuals applied.");
        }

        async function fetchModels() {
            const apiUrl = document.getElementById('global-api-url').value;
            const apiKey = document.getElementById('global-api-key').value;
            const btn = document.querySelector('button[onclick="fetchModels()"] i');
            if(!apiUrl || !apiKey) { alert("Enter URL and Key first."); return; }
            btn.className = "fas fa-sync-alt fa-spin";
            try {
                const res = await fetch(`${apiUrl}/models`, { method: 'GET', headers: { 'Authorization': `Bearer ${apiKey}` } });
                if(!res.ok) throw new Error("Fetch failed: " + res.status);
                const data = await res.json();
                if(data.data && Array.isArray(data.data)) {
                    const select = document.getElementById('global-model-select'); select.innerHTML = '';
                    data.data.sort((a,b) => a.id.localeCompare(b.id));
                    data.data.forEach(m => { const opt = document.createElement('option'); opt.value = m.id; opt.innerText = m.id; select.appendChild(opt); });
                    alert(`Found ${data.data.length} models.`);
                } else throw new Error("Invalid format");
            } catch(e) { alert("Error fetching models: " + e.message); } finally { btn.className = "fas fa-sync-alt"; }
        }

        // --- COMMON ---
        function renderWbTargetCheckboxes(selectedTargets = []) {
            if(!Array.isArray(selectedTargets)) selectedTargets = [selectedTargets];
            const container = document.getElementById('wb-target-list'); container.innerHTML = '';
            if(contacts.length === 0) { container.innerHTML = '<div style="color:#666; padding:5px; font-size:12px;">No souls available.</div>'; return; }
            contacts.forEach(c => { 
                const div = document.createElement('div'); div.className = 'wb-checkbox-item';
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = c.name; checkbox.id = `wb-chk-${c.id}`;
                if(selectedTargets.includes(c.name)) checkbox.checked = true;
                const label = document.createElement('label'); label.htmlFor = `wb-chk-${c.id}`; label.innerText = c.name;
                div.appendChild(checkbox); div.appendChild(label); container.appendChild(div);
            });
        }
        function openWorldBookModal() { wbEditIndex = -1; document.getElementById('wb-modal-title').innerText = "Inscribe New Lore"; document.getElementById('wb-title').value = ''; document.getElementById('wb-content').value = ''; renderWbTargetCheckboxes([]); document.querySelector('input[name="scope"][value="global"]').checked = true; toggleWbScope(); document.getElementById('wb-modal').style.display = 'flex'; }
        function toggleWbScope() { document.getElementById('wb-target-div').style.display = document.querySelector('input[name="scope"]:checked').value === 'local' ? 'block' : 'none'; }
        function saveWorldBookEntry() {
            const title = document.getElementById('wb-title').value.trim(); const content = document.getElementById('wb-content').value.trim();
            const scope = document.querySelector('input[name="scope"]:checked').value; 
            let targets = []; document.querySelectorAll('#wb-target-list input[type="checkbox"]:checked').forEach(chk => targets.push(chk.value));
            if(!title || !content) return;
            const entry = { title, content, scope, target: scope==='local' ? targets : null };
            if(wbEditIndex === -1) worldBook.push(entry); else worldBook[wbEditIndex] = entry;
            saveData(); renderWorldBook(); closeModal('wb-modal');
        }
        function renderWorldBook() {
            const list = document.getElementById('world-book-list'); list.innerHTML = '';
            worldBook.forEach((entry, index) => {
                const div = document.createElement('div'); div.className = 'lore-entry';
                let targetText = ''; if(entry.scope === 'local') { const t = Array.isArray(entry.target) ? entry.target.join(", ") : entry.target; targetText = `<div class="lore-target">Bound to: ${t}</div>`; }
                div.innerHTML = `<div class="lore-header"><h3 class="lore-title">${escapeHtml(entry.title)}</h3><span class="lore-scope-tag ${entry.scope === 'global' ? 'tag-global' : 'tag-local'}">${entry.scope.toUpperCase()}</span></div><p class="lore-content">${escapeHtml(entry.content)}</p>${targetText}<div class="lore-actions"><button class="icon-btn" onclick="editLore(${index})"><i class="fas fa-pen-nib"></i></button><button class="icon-btn" onclick="deleteLore(${index})"><i class="fas fa-trash"></i></button></div>`;
                list.appendChild(div);
            });
        }
        function editLore(index) { wbEditIndex = index; const entry = worldBook[index]; document.getElementById('wb-title').value = entry.title; document.getElementById('wb-content').value = entry.content; const targets = Array.isArray(entry.target) ? entry.target : (entry.target ? [entry.target] : []); renderWbTargetCheckboxes(targets); const radios = document.getElementsByName('scope'); for(let r of radios) { if(r.value === entry.scope) r.checked = true; } toggleWbScope(); document.getElementById('wb-modal').style.display = 'flex'; }
        function deleteLore(index) { if(confirm("Burn page?")) { worldBook.splice(index, 1); saveData(); renderWorldBook(); } }
        function updateClock() { const now = new Date(); document.getElementById('clock').innerText = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0'); const widget = document.getElementById('home-widget-clock'); if(widget) widget.innerText = document.getElementById('clock').innerText; }
        function toggleFullScreenMode() { document.body.classList.remove('no-frame-mode'); if (document.body.classList.contains('full-screen-mode')) { document.body.classList.remove('full-screen-mode'); localStorage.setItem('gothic_display_mode', 'default'); } else { document.body.classList.add('full-screen-mode'); localStorage.setItem('gothic_display_mode', 'fullscreen'); } }
        function toggleNoFrameMode() { document.body.classList.remove('full-screen-mode'); if (document.body.classList.contains('no-frame-mode')) { document.body.classList.remove('no-frame-mode'); localStorage.setItem('gothic_display_mode', 'default'); } else { document.body.classList.add('no-frame-mode'); localStorage.setItem('gothic_display_mode', 'noframe'); } }
        function escapeHtml(text) { if(!text) return ''; return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); }
        
        function handleImport(input) {
            const file = input.files[0]; if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(!data.contacts && !data.globalSettings) throw new Error("Invalid Soul Core file.");
                    if(confirm("Overwrite current reality with this backup?")) {
                        if(data.contacts) localStorage.setItem('gothic_contacts', JSON.stringify(data.contacts));
                        if(data.worldBook) localStorage.setItem('gothic_worldbook', JSON.stringify(data.worldBook));
                        if(data.homePrefs) localStorage.setItem('gothic_home_prefs', JSON.stringify(data.homePrefs));
                        if(data.globalSettings) {
                            if(data.globalSettings.apiUrl) localStorage.setItem('gothic_api_url', data.globalSettings.apiUrl);
                            if(data.globalSettings.globalCss) localStorage.setItem('gothic_global_css', data.globalSettings.globalCss);
                        }
                        alert("Reality rewritten. System restarting..."); location.reload();
                    }
                } catch(err) { alert("Import failed: " + err.message); }
            };
            reader.readAsText(file); input.value = '';
        }
        function askWipeData() { document.getElementById('modal-wipe-all').style.display = 'flex'; }
        function confirmWipeData() { localStorage.clear(); location.reload(); }
    </script>
</body>
</html>
